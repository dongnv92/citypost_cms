<?php
$app_id         = 'Qh8TrDFLaB18FUtvss1Q'; // Here Maps
$app_code       = '05y5O5MgLVe0xHFNgwKYpw'; // Here Maps
define('_WAYPOINT_ST', '900'); // Thời gian  nghỉ tại mỗi điểm giao hàng

$address        = array();
//$address[]      = array('address' => 'Phòng khám đa khoa yên hòa'  , 'lat' => '21.022248'  , 'lng' => '105.786536'     , 'weigh' => 320);
$address[]      = array('address' => '186 Thái Thịnh'              , 'lat' => '21.0132361' , 'lng' => '105.8158118'    , 'weigh' => 532);
$address[]      = array('address' => '1a Hồ Đắc Di'                , 'lat' => '21.0110527' , 'lng' => '105.8307426'    , 'weigh' => 125);
$address[]      = array('address' => '46 Lê Trọng Tấn'             , 'lat' => '20.999785'  , 'lng' => '105.827951'     , 'weigh' => 965);
$address[]      = array('address' => '37 Lê Thanh Nghị'            , 'lat' => '21.0029783' , 'lng' => '105.8478191'    , 'weigh' => 456);
$address[]      = array('address' => '37 Lý Quốc Sư'               , 'lat' => '21.0298324' , 'lng' => '105.8493554'    , 'weigh' => 741);
$address[]      = array('address' => '27 Đinh Tiên Hoàng'          , 'lat' => '21.032023'  , 'lng' => '105.8525637'    , 'weigh' => 985);
$address[]      = array('address' => '83 Hàng Điếu'                , 'lat' => '21.032'     , 'lng' => '105.846889'     , 'weigh' => 235);
$address[]      = array('address' => '43 Đỗ Quang'                 , 'lat' => '21.0110512' , 'lng' => '105.8021868'    , 'weigh' => 652);
$address[]      = array('address' => '102 Linh Lang'               , 'lat' => '21.0350987' , 'lng' => '105.8104195'    , 'weigh' => 123);
$address[]      = array('address' => '36 Tràng Tiền'               , 'lat' => '21.024949'  , 'lng' => '105.855086'     , 'weigh' => 234);
$address[]      = array('address' => '54 Tô Ngọc Vân'              , 'lat' => '21.0687818' , 'lng' => '105.824109'     , 'weigh' => 345);
$address[]      = array('address' => '126 Nam Cao'                 , 'lat' => '21.030116'  , 'lng' => '105.822275'     , 'weigh' => 456);
$address[]      = array('address' => 'Ngõ 97 Văn Cao Liễu Giai'    , 'lat' => '21.0390912' , 'lng' => '105.8167'       , 'weigh' => 56);
$address[]      = array('address' => '13 Ngũ Xã'                   , 'lat' => '21.0462725' , 'lng' => '105.8422213'    , 'weigh' => 679);
$address[]      = array('address' => '106 Hoàng Quốc Việt'         , 'lat' => '21.0468178' , 'lng' => '105.795193'     , 'weigh' => 912);
$address[]      = array('address' => '162 Phố Mai Dịch'            , 'lat' => '21.0405269' , 'lng' => '105.7746359'    , 'weigh' => 23);
$address[]      = array('address' => '3 Phạm Tuấn Tài'             , 'lat' => '21.0416899' , 'lng' => '105.7861699'    , 'weigh' => 289);
$address[]      = array('address' => '117 Xuân Thủy'               , 'lat' => '21.036416'  , 'lng' => '105.7870385'    , 'weigh' => 178);
$address[]      = array('address' => '1 Nguyễn Hoàng'              , 'lat' => '21.0291361' , 'lng' => '105.7761154'    , 'weigh' => 589);
$address[]      = array('address' => '192A Quán Thánh'             , 'lat' => '21.042731'  , 'lng' => '105.837819'     , 'weigh' => 397);
$address[]      = array('address' => '35 Tân Ấp'                   , 'lat' => '21.046135'  , 'lng' => '105.846476'     , 'weigh' => 712);
$address[]      = array('address' => '36 Phạm Hùng'                , 'lat' => '21.0279212' , 'lng' => '105.7782125'    , 'weigh' => 523);
$address[]      = array('address' => 'Ngõ 32 An Dương'             , 'lat' => '21.050874'  , 'lng' => '105.842910'     , 'weigh' => 31);
$address[]      = array('address' => '74 Nguyễn Trường Tộ'         , 'lat' => '21.043289'  , 'lng' => '105.842815'     , 'weigh' => 378);
$address[]      = array('address' => '85 Phan Văn Trường'          , 'lat' => '21.0410848' , 'lng' => '105.7861558'    , 'weigh' => 98);
$address[]      = array('address' => '2 Nghi Tàm'                  , 'lat' => '21.056844'  , 'lng' => '105.836303'     , 'weigh' => 56);
$address[]      = array('address' => '18/4 Kim Đồng'               , 'lat' => '20.983084'  , 'lng' => '105.842031'     , 'weigh' => 47);
$address[]      = array('address' => '195B Đội Cấn'                , 'lat' => '21.035078'  , 'lng' => '105.823434'     , 'weigh' => 22);
$address[]      = array('address' => '12 Nguyễn Tri Phương'       , 'lat' => '21.036735'  , 'lng' => '105.841237'     , 'weigh' => 39);
$address[]      = array('address' => 'Ngõ 7 Hà Cầu Hà Đông'       , 'lat' => '20.966826'  , 'lng' => '105.784734'     , 'weigh' => 63);
$address[]      = array('address' => '66 Bạch Thái Bưởi'           , 'lat' => '20.969897'  , 'lng' => '105.789452'     , 'weigh' => 52);

$url                    = 'https://wse.api.here.com/2/findsequence.json?';
$data                   = array();
$data['app_code']       = $app_code;
$data['app_id']         = $app_id;
$data['start']          = 'Phòng khám đa khoa yên hòa start;21.022248,105.786536';
$data['end']            = 'Phòng khám đa khoa yên hòa end;21.022248,105.786536';
$data['mode']           = 'fastest;car;traffic:enabled;';
$data['improveFor']     = 'distance';
$data['departure']      = date('Y-m-d', time()).'T09:00:00+07';

$i                      = 0;
foreach ($address AS $list_address){
    $i++;
    $data['destination'.$i] = $list_address['address'].';'.$list_address['lat'].','.$list_address['lng'].';st:'._WAYPOINT_ST;
}

foreach ($data as $key => $value){
    $datas[]            = $key .'='. urlencode($value);
}

$data                   = implode('&', $datas);
$ch = curl_init($url.$data);
curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/x-www-form-urlencoded'));
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-GB; rv:1.8.1.6) Gecko/20070725 Firefox/2.0.0.6');
curl_setopt($ch, CURLOPT_POST, 1);
curl_setopt($ch, CURLOPT_POSTFIELDS, '');
$result = curl_exec($ch);
curl_close($ch);
$result = json_decode($result, true);

$i = 0;
foreach ($result['results'][0]['waypoints'] AS $address_away){
    $waypoint[] = 'waypoint'.$i.':\''.$address_away['lat'].','. $address_away['lng']."'";
    $i++;
}
$waypoints = implode(',', $waypoint);
?>
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.0/mapsjs-ui.css?dp-version=1533195059" />
    <script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-core.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-service.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-ui.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.0/mapsjs-mapevents.js"></script>
    <style type="text/css">
        .directions li span.arrow {
            display:inline-block;
            min-width:28px;
            min-height:28px;
            background-position:0px;
            background-image: url("../img/arrows.png");
            position:relative;
            top:8px;
        }
        .directions li span.depart  {
            background-position:-28px;
        }
        .directions li span.rightUTurn  {
            background-position:-56px;
        }
        .directions li span.leftUTurn  {
            background-position:-84px;
        }
        .directions li span.rightFork  {
            background-position:-112px;
        }
        .directions li span.leftFork  {
            background-position:-140px;
        }
        .directions li span.rightMerge  {
            background-position:-112px;
        }
        .directions li span.leftMerge  {
            background-position:-140px;
        }
        .directions li span.slightRightTurn  {
            background-position:-168px;
        }
        .directions li span.slightLeftTurn{
            background-position:-196px;
        }
        .directions li span.rightTurn  {
            background-position:-224px;
        }
        .directions li span.leftTurn{
            background-position:-252px;
        }
        .directions li span.sharpRightTurn  {
            background-position:-280px;
        }
        .directions li span.sharpLeftTurn{
            background-position:-308px;
        }
        .directions li span.rightRoundaboutExit1 {
            background-position:-616px;
        }
        .directions li span.rightRoundaboutExit2 {
            background-position:-644px;
        }

        .directions li span.rightRoundaboutExit3 {
            background-position:-672px;
        }

        .directions li span.rightRoundaboutExit4 {
            background-position:-700px;
        }

        .directions li span.rightRoundaboutPass {
            background-position:-700px;
        }

        .directions li span.rightRoundaboutExit5 {
            background-position:-728px;
        }
        .directions li span.rightRoundaboutExit6 {
            background-position:-756px;
        }
        .directions li span.rightRoundaboutExit7 {
            background-position:-784px;
        }
        .directions li span.rightRoundaboutExit8 {
            background-position:-812px;
        }
        .directions li span.rightRoundaboutExit9 {
            background-position:-840px;
        }
        .directions li span.rightRoundaboutExit10 {
            background-position:-868px;
        }
        .directions li span.rightRoundaboutExit11 {
            background-position:896px;
        }
        .directions li span.rightRoundaboutExit12 {
            background-position:924px;
        }
        .directions li span.leftRoundaboutExit1  {
            background-position:-952px;
        }
        .directions li span.leftRoundaboutExit2  {
            background-position:-980px;
        }
        .directions li span.leftRoundaboutExit3  {
            background-position:-1008px;
        }
        .directions li span.leftRoundaboutExit4  {
            background-position:-1036px;
        }
        .directions li span.leftRoundaboutPass {
            background-position:1036px;
        }
        .directions li span.leftRoundaboutExit5  {
            background-position:-1064px;
        }
        .directions li span.leftRoundaboutExit6  {
            background-position:-1092px;
        }
        .directions li span.leftRoundaboutExit7  {
            background-position:-1120px;
        }
        .directions li span.leftRoundaboutExit8  {
            background-position:-1148px;
        }
        .directions li span.leftRoundaboutExit9  {
            background-position:-1176px;
        }
        .directions li span.leftRoundaboutExit10  {
            background-position:-1204px;
        }
        .directions li span.leftRoundaboutExit11  {
            background-position:-1232px;
        }
        .directions li span.leftRoundaboutExit12  {
            background-position:-1260px;
        }
        .directions li span.arrive  {
            background-position:-1288px;
        }
        .directions li span.leftRamp  {
            background-position:-392px;
        }
        .directions li span.rightRamp  {
            background-position:-420px;
        }
        .directions li span.leftExit  {
            background-position:-448px;
        }
        .directions li span.rightExit  {
            background-position:-476px;
        }

        .directions li span.ferry  {
            background-position:-1316px;
    </style>
</head>
<body>

<div id="map" style="position:absolute; width:49%; height:100%; background:grey" ></div>
<div id="panel" style="position:absolute; width:49%; left:51%; height:100%; background:inherit" ></div>

<script  type="text/javascript" charset="UTF-8" >
    function calculateRouteFromAtoB (platform) {
        var router = platform.getRoutingService(),
            routeRequestParams = {
                mode: 'fastest;car',
                representation: 'display',
                routeattributes : 'waypoints,summary,shape,legs',
                maneuverattributes: 'direction,action',
                <?php echo $waypoints;?>
            };

        router.calculateRoute(
            routeRequestParams,
            onSuccess,
            onError
        );
    }
    /**
     * This function will be called once the Routing REST API provides a response
     * @param  {Object} result          A JSONP object representing the calculated route
     *
     * see: http://developer.here.com/rest-apis/documentation/routing/topics/resource-type-calculate-route.html
     */
    function onSuccess(result) {
        var route = result.response.route[0];
        /*
         * The styling of the route response on the map is entirely under the developer's control.
         * A representitive styling can be found the full JS + HTML code of this example
         * in the functions below:
         */
        addRouteShapeToMap(route);
        addManueversToMap(route);

        addWaypointsToPanel(route.waypoint);
        addManueversToPanel(route);
        addSummaryToPanel(route.summary);
        // ... etc.
    }

    /**
     * This function will be called if a communication error occurs during the JSON-P request
     * @param  {Object} error  The error message received.
     */
    function onError(error) {
        alert('Ooops!');
    }

// set up containers for the map  + panel
    var mapContainer = document.getElementById('map'),
        routeInstructionsContainer = document.getElementById('panel');

    //Step 1: initialize communication with the platform
    var platform = new H.service.Platform({
        app_id: '<?php echo $app_id;?>',
        app_code: '<?php echo $app_code;?>',
        useHTTPS: true,
        lang : 'vi'
    });
    var pixelRatio = window.devicePixelRatio || 1;
    var defaultLayers = platform.createDefaultLayers({
        tileSize: pixelRatio === 1 ? 256 : 512,
        ppi: pixelRatio === 1 ? undefined : 320
    });

    //Step 2: initialize a map - this map is centered over Berlin
    var map = new H.Map(mapContainer,
        defaultLayers.normal.map,{
            center: {lat:21.017733, lng:105.780973},
            zoom: 13,
            pixelRatio: pixelRatio
        });

    //Step 3: make the map interactive
    // MapEvents enables the event system
    // Behavior implements default interactions for pan/zoom (also on mobile touch environments)
    var behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));

    // Create the default UI components
    var ui = H.ui.UI.createDefault(map, defaultLayers);

    // Hold a reference to any infobubble opened
    var bubble;

    /**
     * Opens/Closes a infobubble
     * @param  {H.geo.Point} position     The location on the map.
     * @param  {String} text              The contents of the infobubble.
     */
    function openBubble(position, text){
        if(!bubble){
            bubble =  new H.ui.InfoBubble(
                position,
                // The FO property holds the province name.
                {content: text});
            ui.addBubble(bubble);
        } else {
            bubble.setPosition(position);
            bubble.setContent('Dong: ' + text);
            bubble.open();
        }
    }


    /**
     * Creates a H.map.Polyline from the shape of the route and adds it to the map.
     * @param {Object} route A route as received from the H.service.RoutingService
     */
    function addRouteShapeToMap(route){
        var lineString = new H.geo.LineString(),
            routeShape = route.shape,
            polyline;

        routeShape.forEach(function(point) {
            var parts = point.split(',');
            lineString.pushLatLngAlt(parts[0], parts[1]);
        });

        polyline = new H.map.Polyline(lineString, {
            style: {
                lineWidth: 4,
                strokeColor: 'rgba(0, 128, 255, 0.7)'
            }
        });
        // Add the polyline to the map
        map.addObject(polyline);
        // And zoom to its bounding rectangle
        map.setViewBounds(polyline.getBounds(), true);
    }


    /**
     * Creates a series of H.map.Marker points from the route and adds them to the map.
     * @param {Object} route  A route as received from the H.service.RoutingService
     */
    function addManueversToMap(route){
        var markupTemplate = '<svg xmlns="http://www.w3.org/2000/svg" width="28px" height="36px"><path d="M 19 31 C 19 32.7 16.3 34 13 34 C 9.7 34 7 32.7 7 31 C 7 29.3 9.7 28 13 28 C 16.3 28 19 29.3 19 31 Z" fill="#000" fill-opacity=".2"/><path d="M 13 0 C 9.5 0 6.3 1.3 3.8 3.8 C 1.4 7.8 0 9.4 0 12.8 C 0 16.3 1.4 19.5 3.8 21.9 L 13 31 L 22.2 21.9 C 24.6 19.5 25.9 16.3 25.9 12.8 C 25.9 9.4 24.6 6.1 22.1 3.8 C 19.7 1.3 16.5 0 13 0 Z" fill="#fff"/><path d="M 13 2.2 C 6 2.2 2.3 7.2 2.1 12.8 C 2.1 16.1 3.1 18.4 5.2 20.5 L 13 28.2 L 20.8 20.5 C 22.9 18.4 23.8 16.2 23.8 12.8 C 23.6 7.07 20 2.2 13 2.2 Z" fill="#18d"/><text x="13" y="19" font-size="12pt" font-weight="bold" text-anchor="middle" fill="#fff">${text}</text></svg>',
            group = new  H.map.Group(),
            i,
            j;

        // Add a marker for each maneuver
        for (i = 0;  i < route.leg.length; i += 1) {
            for (j = 0;  j < route.leg[i].maneuver.length; j += 1) {
                if(j == (route.leg[i].maneuver.length -1) || (i == 0 && j == 0)){
                    maneuver = route.leg[i].maneuver[j];
                    var markup = markupTemplate.replace('${text}', (i == 0 && j == 0) ? i + 1 : i + 2),
                        icon = new H.map.Icon(markup),
                        marker =  new H.map.Marker({
                                lat: maneuver.position.latitude,
                                lng: maneuver.position.longitude},
                            {icon: icon});
                    marker.instruction = maneuver.instruction;
                    group.addObject(marker);
                }
            }
        }
        // End add a marker for each maneuver

        group.addEventListener('tap', function (evt) {
            map.setCenter(evt.target.getPosition());
            openBubble(
                evt.target.getPosition(), evt.target.instruction);
        }, false);

        // Add the maneuvers group to the map
        map.addObject(group);
    }


    /**
     * Creates a series of H.map.Marker points from the route and adds them to the map.
     * @param {Object} route  A route as received from the H.service.RoutingService
     */
    function addWaypointsToPanel(waypoints){
        var nodeH3 = document.createElement('h3'),
            waypointLabels = [],
            i;
        for (i = 0;  i < waypoints.length; i += 1) {
            waypointLabels.push(waypoints[i].label)
        }
        nodeH3.textContent = waypointLabels.join(' - ');
        routeInstructionsContainer.innerHTML = '';
        routeInstructionsContainer.appendChild(nodeH3);
    }

    /**
     * Creates a series of H.map.Marker points from the route and adds them to the map.
     * @param {Object} route  A route as received from the H.service.RoutingService
     */
    function addSummaryToPanel(summary){
        var summaryDiv = document.createElement('div'),
            content = '';
        content += '<b>Total distance</b>: ' + summary.distance  + 'm. <br/>';
        content += '<b>Travel Time</b>: ' + summary.travelTime.toMMSS() + ' (in current traffic)';


        summaryDiv.style.fontSize = 'small';
        summaryDiv.style.marginLeft ='5%';
        summaryDiv.style.marginRight ='5%';
        summaryDiv.innerHTML = content;
        routeInstructionsContainer.appendChild(summaryDiv);
    }

    /**
     * Creates a series of H.map.Marker points from the route and adds them to the map.
     * @param {Object} route  A route as received from the H.service.RoutingService
     */
    function addManueversToPanel(route){



        var nodeOL = document.createElement('ol'),
            i,
            j;

        nodeOL.style.fontSize = 'small';
        nodeOL.style.marginLeft ='5%';
        nodeOL.style.marginRight ='5%';
        nodeOL.className = 'directions';

        // Add a marker for each maneuver
        for (i = 0;  i < route.leg.length; i += 1) {
            for (j = 0;  j < route.leg[i].maneuver.length; j += 1) {
                // Get the next maneuver.
                maneuver = route.leg[i].maneuver[j];
                var li = document.createElement('li'),
                    spanArrow = document.createElement('span'),
                    spanInstruction = document.createElement('span');

                spanArrow.className = 'arrow '  + maneuver.action;
                spanInstruction.innerHTML = maneuver.instruction;
                li.appendChild(spanArrow);
                li.appendChild(spanInstruction);

                nodeOL.appendChild(li);
            }
        }

        routeInstructionsContainer.appendChild(nodeOL);
    }


    Number.prototype.toMMSS = function () {
        return  Math.floor(this / 60)  +' minutes '+ (this % 60)  + ' seconds.';
    }

    // Now use the map as required...
    calculateRouteFromAtoB (platform);
</script>
</body>
</html>